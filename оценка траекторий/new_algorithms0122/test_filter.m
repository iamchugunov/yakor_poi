N = 4;

% poits = traj(N).poits;

k = 1;
X = [];
discr = [];

X0 = [];
while k < length(poits)
    if poits(k).count == 4
        [X0, flag, dop, nev, hei_geo] = NavSolverRDinv_h(poits(k).rd, config.posts, [0;0], -15000:1000:15000, config);
        if flag
            break
        end
    end 
    k = k + 1;
end

X(:,1) = [X0(1); 0; 0; X0(2); 0; 0; 5000; 0; 0];
Dx = eye(9);
% Dx = [2127850590.32973,295821600.894553,23230487.5350426,-56535630.3279465,-8067644.67658691,-653540.914306474,-135380619.717464,-17575342.5340540,-1315834.67834514;295821600.894553,46227859.4227062,4421813.09882825,-7923455.83253767,-1278401.42722691,-121543.919704111,-18751219.3117828,-2735104.06879011,-238778.188770582;23230487.5350426,4421813.09882825,727598.675638439,-630378.244425063,-122224.093376421,-14964.8113287337,-1458604.63625883,-249387.832268538,-26751.7519647264;-56535630.3279464,-7923455.83253767,-630378.244425063,23499856.6574267,6222522.98508442,928928.233325353,-17892551.6119133,-5325747.98412527,-787580.204026558;-8067644.67658691,-1278401.42722691,-122224.093376421,6222522.98508443,2580340.01971856,604018.981406449,-5279791.60170680,-2245565.28525268,-399317.665784300;-653540.914306479,-121543.919704112,-14964.8113287338,928928.233325354,604018.981406450,330042.463800323,-778753.683751543,-398472.798098547,-85862.4230861333;-135380619.717464,-18751219.3117828,-1458604.63625883,-17892551.6119133,-5279791.60170680,-778753.683751542,29945583.6134969,6946063.71524654,971952.405280157;-17575342.5340540,-2735104.06879012,-249387.832268538,-5325747.98412527,-2245565.28525268,-398472.798098547,6946063.71524654,2636148.22984813,602521.702583794;-1315834.67834515,-238778.188770583,-26751.7519647265,-787580.204026556,-399317.665784299,-85862.4230861332,971952.405280156,602521.702583794,328453.420952365];
D_ksi = eye(3) * 100000;

nums = find([poits.count] == 4);
poits1 = poits(nums);
for i = 2:length(poits1)
    dt = poits1(i).Frame - poits1(i-1).Frame;
    [X(:,i), Dx, discr1] = Kalman_step_3Drd(poits1(i).rd, X(:,i-1), Dx, dt, 0, D_ksi, config);
    discr(i) = norm(discr1);
end